From 64956d3476323e06806a3d2045d04447c68cad1f Mon Sep 17 00:00:00 2001
From: Alberto Murillo <alberto.murillo.silva@intel.com>
Date: Thu, 10 Mar 2016 12:24:28 -0600
Subject: [PATCH] Add support to httdp and nginx

---
 nova/wsgi/api.ini                 |  9 +++++++++
 nova/wsgi/metadata.ini            |  9 +++++++++
 nova/wsgi/nova-api-metadata.httpd | 24 ++++++++++++++++++++++++
 nova/wsgi/nova-api-metadata.nginx |  9 +++++++++
 nova/wsgi/nova-api.httpd          | 24 ++++++++++++++++++++++++
 nova/wsgi/nova-api.nginx          |  9 +++++++++
 nova/wsgi/nova-api.py             |  2 +-
 nova/wsgi/nova-metadata.py        |  2 +-
 8 files changed, 86 insertions(+), 2 deletions(-)
 create mode 100644 nova/wsgi/api.ini
 create mode 100644 nova/wsgi/metadata.ini
 create mode 100644 nova/wsgi/nova-api-metadata.httpd
 create mode 100644 nova/wsgi/nova-api-metadata.nginx
 create mode 100644 nova/wsgi/nova-api.httpd
 create mode 100644 nova/wsgi/nova-api.nginx

diff --git a/nova/wsgi/api.ini b/nova/wsgi/api.ini
new file mode 100644
index 0000000..7886f90
--- /dev/null
+++ b/nova/wsgi/api.ini
@@ -0,0 +1,9 @@
+[uwsgi]
+master = true
+processes = 3
+threads = 10
+protocol = uwsgi
+chdir = /usr/share/httpd/cgi-bin
+wsgi-file = nova/nova-api.py
+uid = nova
+gid = nova
diff --git a/nova/wsgi/metadata.ini b/nova/wsgi/metadata.ini
new file mode 100644
index 0000000..ee8502b
--- /dev/null
+++ b/nova/wsgi/metadata.ini
@@ -0,0 +1,9 @@
+[uwsgi]
+master = true
+processes = 3
+threads = 10
+protocol = uwsgi
+chdir = /usr/share/httpd/cgi-bin
+wsgi-file = nova/nova-metadata.py
+uid = nova
+gid = nova
diff --git a/nova/wsgi/nova-api-metadata.httpd b/nova/wsgi/nova-api-metadata.httpd
new file mode 100644
index 0000000..b231f1c
--- /dev/null
+++ b/nova/wsgi/nova-api-metadata.httpd
@@ -0,0 +1,24 @@
+Listen 8775
+
+<VirtualHost *:8775>
+    WSGIDaemonProcess nova-metadata processes=5 threads=1 user=nova group=nova display-name=%{GROUP}
+    WSGIProcessGroup nova-metadata
+    WSGIScriptAlias / /usr/share/httpd/cgi-bin/nova/nova-metadata.py
+    WSGIApplicationGroup %{GLOBAL}
+    WSGIPassAuthorization On
+    <IfVersion >= 2.4>
+      ErrorLogFormat "%{cu}t %M"
+    </IfVersion>
+    ErrorLog /var/log/httpd/nova-metadata-error_log
+    CustomLog /var/log/httpd/nova-metadata-access_log combined
+
+    <Directory /usr/local/bin>
+        <IfVersion >= 2.4>
+            Require all granted
+        </IfVersion>
+        <IfVersion < 2.4>
+            Order allow,deny
+            Allow from all
+        </IfVersion>
+    </Directory>
+</VirtualHost>
diff --git a/nova/wsgi/nova-api-metadata.nginx b/nova/wsgi/nova-api-metadata.nginx
new file mode 100644
index 0000000..0723fdc
--- /dev/null
+++ b/nova/wsgi/nova-api-metadata.nginx
@@ -0,0 +1,9 @@
+server {
+       listen 8775;
+       server_name localhost;
+       location / {
+                include uwsgi_params;
+                uwsgi_pass unix:/run/uwsgi/nova/metadata.sock;
+                uwsgi_param SCRIPT_NAME '';
+       }
+}
diff --git a/nova/wsgi/nova-api.httpd b/nova/wsgi/nova-api.httpd
new file mode 100644
index 0000000..c50aa37
--- /dev/null
+++ b/nova/wsgi/nova-api.httpd
@@ -0,0 +1,24 @@
+Listen 8774
+
+<VirtualHost *:8774>
+    WSGIDaemonProcess nova-api processes=5 threads=1 user=nova group=nova display-name=%{GROUP}
+    WSGIProcessGroup nova-api
+    WSGIScriptAlias / /usr/share/httpd/cgi-bin/nova/nova-api.py
+    WSGIApplicationGroup %{GLOBAL}
+    WSGIPassAuthorization On
+    <IfVersion >= 2.4>
+      ErrorLogFormat "%{cu}t %M"
+    </IfVersion>
+    ErrorLog /var/log/httpd/nova-api-error_log
+    CustomLog /var/log/httpd/nova-api-access_log combined
+
+    <Directory /usr/local/bin>
+        <IfVersion >= 2.4>
+            Require all granted
+        </IfVersion>
+        <IfVersion < 2.4>
+            Order allow,deny
+            Allow from all
+        </IfVersion>
+    </Directory>
+</VirtualHost>
diff --git a/nova/wsgi/nova-api.nginx b/nova/wsgi/nova-api.nginx
new file mode 100644
index 0000000..f367322
--- /dev/null
+++ b/nova/wsgi/nova-api.nginx
@@ -0,0 +1,9 @@
+server {
+       listen 8774;
+       server_name localhost;
+       location / {
+                include uwsgi_params;
+                uwsgi_pass unix:/run/uwsgi/nova/api.sock;
+                uwsgi_param SCRIPT_NAME '';
+       }
+}
diff --git a/nova/wsgi/nova-api.py b/nova/wsgi/nova-api.py
index c0fc77a..d45ee81 100644
--- a/nova/wsgi/nova-api.py
+++ b/nova/wsgi/nova-api.py
@@ -27,7 +27,7 @@ from nova import utils
 
 CONF = cfg.CONF
 
-config_files = ['/etc/nova/api-paste.ini', '/etc/nova/nova.conf']
+config_files = ['/usr/share/defaults/nova/api-paste.ini', '/usr/share/defaults/nova/nova.conf', '/etc/nova/nova.conf']
 config.parse_args([], default_config_files=config_files)
 
 logging.setup(CONF, "nova")
diff --git a/nova/wsgi/nova-metadata.py b/nova/wsgi/nova-metadata.py
index d2ee9e9..d36f961 100644
--- a/nova/wsgi/nova-metadata.py
+++ b/nova/wsgi/nova-metadata.py
@@ -27,7 +27,7 @@ from nova import utils
 
 CONF = cfg.CONF
 
-config_files = ['/etc/nova/api-paste.ini', '/etc/nova/nova.conf']
+config_files = ['/usr/share/defaults/nova/api-paste.ini', '/usr/share/defaults/nova/nova.conf', '/etc/nova/nova.conf']
 config.parse_args([], default_config_files=config_files)
 
 logging.setup(CONF, "nova")
-- 
2.5.0

